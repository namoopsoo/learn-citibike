### Citibike Project: Can your Destination be Predicted

#### Motivation
I think sometimes the most interesting projects live behind ideas that sound impractical or even crazy. That's why I thought
it would be fun to use the Citibike bike share trip data to try and predict a person's destination based on what we know.

_Roughly speaking trip data looks like this_

```
"tripduration","starttime","stoptime","start station id","start station name","start station latitude","start station longitude","end station id","end station name","end station latitude","end station longitude","bikeid","usertype","birth year","gender"
"171","10/1/2015 00:00:02","10/1/2015 00:02:54","388","W 26 St & 10 Ave","40.749717753","-74.002950346","494","W 26 St & 8 Ave","40.74734825","-73.99723551","24302","Subscriber","1973","1"
"593","10/1/2015 00:00:02","10/1/2015 00:09:55","518","E 39 St & 2 Ave","40.74780373","-73.9734419","438","St Marks Pl & 1 Ave","40.72779126","-73.98564945","19904","Subscriber","1990","1"
"233","10/1/2015 00:00:11","10/1/2015 00:04:05","447","8 Ave & W 52 St","40.76370739","-73.9851615","447","8 Ave & W 52 St","40.76370739","-73.9851615","17797","Subscriber","1984","1"
"250","10/1/2015 00:00:15","10/1/2015 00:04:25","336","Sullivan St & Washington Sq","40.73047747","-73.99906065","223","W 13 St & 7 Ave","40.73781509","-73.99994661","23966","Subscriber","1984","1"
"528","10/1/2015 00:00:17","10/1/2015 00:09:05","3107","Bedford Ave & Nassau Ave","40.72311651","-73.95212324","539","Metropolitan Ave & Bedford Ave","40.71534825","-73.96024116","16246","Customer","","0"
"440","10/1/2015 00:00:17","10/1/2015 00:07:37","3107","Bedford Ave & Nassau Ave","40.72311651","-73.95212324","539","Metropolitan Ave & Bedford Ave","40.71534825","-73.96024116","23698","Customer","","0"
```

The data if fairly clean and regular, so I thought this was a fun data set to sharpen my teeth on.

#### Quick summary of the journey
* First started just [looking](#more-on-this-data) at this data.
* Just out of curiosity, as a first mini starter project I decided to look at the [relationship between rider age and speed](#speed-and-age)
* I realized pretty early that the bike station target was too small, so I started using the Google Geolocation API to get broader location data such
as _zip codes_ and _neighborhoods_ . [geolocation](#need-additional-location-data)
* I also thought on a high level that knowing whether you got on your bike at `4:05` in the afternoon versus `4:06` shouldn't 
influence my learning algorithm, so I added some more [transformations](#time-bucketing).
* 

#### More on this data
* When I started looking at this data, there were 400+ stations for docking your citibike.
* There is age, and some of the riders were actually born in the 1800s, which is kind of cool.

```python
df = load_data('data/201509_10-citibike-tripdata.csv.annotated.100000.06112016T1814.csv')

In [6]: df['birth year'].describe()
Out[6]: 
count    83171.000000
mean      1977.149680
std         11.400096
min       1885.000000
25%       1969.000000
50%       1980.000000
75%       1986.000000
max       1999.000000
Name: birth year, dtype: float64
```

#### Speed and Age
Turns out that you need to know the miles per the longitude degree at a particular latitude on our planet. So for our particular location, 
at lat around `40.723` and using the earth's radius of about `3958 miles` , we have about `52.3 miles/longitude degree`
here in NYC. 
 
So from there, looking at some of the speed data just involved looking at the tripdata trip time and calculating the 
cartesian distance. 
<img src="https://github.com/namoopsoo/learn-citibike/blob/master/notes/assets/Screen%20Shot%202019-05-21%20at%2011.02.41%20AM.png"
width="435" height="307"  >
1758 × 1238

(More on the code [here](https://github.com/namoopsoo/learn-citibike/blob/master/bikelearn/utils.py#L86) )
(Also more detail on this analysis in the main [jupyter notebook](https://github.com/namoopsoo/learn-citibike/blob/master/project%20report.ipynb)) 

#### Need additional location data
* With the 400+ stations, trying to predict a multi-class problem of this sort with basic machine learning algorithms
would not be a way to get quick results to help keep the project going, so I decided to constrain the problem. I ended up
turning to the Google Geocoding API. Using this data because a side project in its own right, because parsing through 
the Google geolocation data can get pretty hairy! 

_The meat of the output can look like this, for the docking station "1st Avenue & E 15th St"_
```python
{
'raw_result': [{u'address_components': [{u'long_name': u'1st Avenue',
                u'short_name': u'1st Avenue',
                u'types': [u'route']},
               {u'long_name': u'Midtown',
                u'short_name': u'Midtown',
                u'types': [u'neighborhood',
                           u'political']},
               {u'long_name': u'Manhattan',
                u'short_name': u'Manhattan',
                u'types': [u'sublocality_level_1',
                           u'sublocality',
                           u'political']},
               {u'long_name': u'New York',
                u'short_name': u'New York',
                u'types': [u'locality',
                           u'political']},
               {u'long_name': u'New York County',
                u'short_name': u'New York County',
                u'types': [u'administrative_area_level_2',
                           u'political']},
               {u'long_name': u'New York',
                u'short_name': u'NY',
                u'types': [u'administrative_area_level_1',
                           u'political']},
               {u'long_name': u'United States',
                u'short_name': u'US',
                u'types': [u'country',
                           u'political']},
               {u'long_name': u'10003',
                u'short_name': u'10003',
                u'types': [u'postal_code']}],
               u'formatted_address': u'1st Avenue & E 15th St, New York, NY 10003, USA',
               }
```


* Some of the challenges here were that the outputs from the API were not always consistent. The above output shows that the  
`'neighborhood'` is `'Midtown'`, but because there were 400+ stations, I did not initially notice that sometimes the `neighborhood`
was missing or that the `zip code` was missing. That ended up throwing off my code a couple of times. 
* It turned out that the _street intersection_ was not an ideal clean data input to the API. For instance `E 3 St & 1 Ave, NY` was understood by the API as just a street or a `route` as it is called, ( [raw output](https://github.com/namoopsoo/learn-citibike/blob/master/notes/assets/E%203%20St%20&%201%20Ave,%20NY.md) ). Later on I ended up refactoring this to 
use the raw _latitude and longitude_ .
* However, I eventually noticed that often times the _docking stations_ were on the edge of neighborhoods. So I literally had 
edge cases! The Neighborhood would come back blank and I ended up having to fill in a lot of that data by hand anyhow!

<img src="https://github.com/namoopsoo/learn-citibike/blob/master/notes/assets/Screen%20Shot%202018-12-04%20at%2012.11.42%20PM.png"
width="457" height="328">
1830 × 1314

* Also the data calls were not free and I ended up building a small _caching layer_ with _redis_ . 
* The other reason I had done that was that I would often work out of cafes where the Wifi was spotty and I didn't want an internet
connection to hold me back.
*  I think in hind-sight, I could have avoided some of the automation here and just decoupled the data fetch so that I wouldn't have to
worry about that internet connection. 
* Of course every time I wanted to add additional data from Citibike, there would be new docking stations and 

#### Time bucketing 


