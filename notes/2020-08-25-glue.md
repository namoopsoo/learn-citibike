

#### making the tarball from the joblib..

```
cd artifacts/2020-08-19T144654Z

ls
# => all_bundle_with_stationsdf.joblib

mkdir model

mv all_bundle_with_stationsdf.joblib model

tar -czf model.tar.gz model
# => creates model.tar.gz , which I can throw into a SageMaker model.

```

#### troubleshoot docker does not run serve command...
- is it not executable? Wrong work dir?

```
$ docker run -p 8889:8889 -p 8080:8080 -i -t -v $(pwd):/opt/program       \
      -v ${my_local_data_directory}:/opt/data        \
      -v   ~/Downloads:/opt/downloads         \
      -v  $(pwd)/artifacts/2020-08-19T144654Z:/opt/ml   citibike-learn:latest  serve

docker: Error response from daemon: OCI runtime create failed: container_linux.go:349: starting container process caused "exec: \"serve\": executable file not found in $PATH": unknown.



```

* Maybe some help [here](https://stackoverflow.com/questions/27158840/docker-executable-file-not-found-in-path) , or [here](https://docs.docker.com/engine/reference/builder/#/cmd)  , with the use of a `CMD` word in the `Dockerfile` .


### 2020-08-26

#### dockerfile
* ok i had just needed to add `/opt/server` to the `PATH` and that fixed it


#### for the probabily outputs from xgboost, got to map those to neighborhoods
* this is the next thing
* and put that mapping into `fresh/lambda.py`
* This information should be in the bundle too. along with the input header too.

#### 54
* `54` output probabilities.


### 2020-08-29

#### test entry code

```python
import fresh.lambda_entry as fl

fl.entry(None, None)

bundle = fl.fetch_bundle()
```

* hmm the bundle requires xgboost, which locally (except for Docker) I dont have and lambda also will not have
* making a slimmed bundle w/o the model...

```python
import fresh.predict_utils as fpu
import joblib
bundle = fpu.load_bundle_in_docker()
del bundle['model_bundle']['bundle']['xgb_model']

blahdir = '/opt/program/artifacts/2020-08-19T144654Z'

joblib.dump(bundle, f'{blahdir}/all_bundle_with_stationsdf_except_xgb.joblib')

```
* And then I saved that to my s3 location
* Try main entry func again w/ the no-xgb bundle

```python
import fresh.lambda_entry as fl
bundle = fl.fetch_bundle()
# fl.map_probabilities(bundle, prob_vec, k=5)
```

* hmm got a scikit learn error now

```
ModuleNotFoundError: No module named 'sklearn.preprocessing._label'
```
* not sure if it helps, but going to align my version ..


```
In [92]: sklearn.__version__                                                                                          
Out[92]: '0.20.2'

In [93]: !pip install -U scikit-learn==0.22.1
```
* oh wow... I tried `fetch_bundle` again after that and bingo!

* ok try also w/ map probabilities...

```python
import fresh.lambda_entry as fl
bundle = fl.fetch_bundle()
out = fl.entry(None, None)

fl.map_probabilities(bundle, prob_vec=out['result'][0], k=5)
```
* ok yay... very cool.

```python
In [8]: fl.map_probabilities(bundle, prob_vec=out['result'][0], k=5)                                                      
Out[8]:
[('Bedford-Stuyvesant', 0.18238812685012817),
 ('Vinegar Hill', 0.0740085020661354),
 ('Columbia Street Waterfront District', 0.07334273308515549),
 ('Downtown Brooklyn', 0.07258936762809753),
 ('Fulton Ferry District', 0.0493587926030159)]
```
* Now just need to add the Google Static Map API call in there. And complete.
* Ah I forgot got a few choices w/ what latlng to chose
```python
stationsdf = bundle['stations_bundle']['stationsdf']
df = fl.map_probabilities(bundle, prob_vec=out['result'][0], k=5)                                                      

In [24]: df.merge(stationsdf, on='neighborhood').iloc[:5][['station_name', 'latlng', 'neighborhood']]                     
Out[24]:
                  station_name                        latlng        neighborhood
0  Lexington Ave & Classon Ave      40.68676793,-73.95928168  Bedford-Stuyvesant
1    Franklin Ave & Myrtle Ave          40.694528,-73.958089  Bedford-Stuyvesant
2   Lefferts Pl & Franklin Ave   40.680342423,-73.9557689392  Bedford-Stuyvesant
3     Hancock St & Bedford Ave      40.68216564,-73.95399026  Bedford-Stuyvesant
4      Macon St & Nostrand Ave  40.6809833854,-73.9500479759  Bedford-Stuyvesant


```
* ..
```python
import fresh.lambda_entry as fl
out = fl.entry(None, None)

```

#### Summary
* Ok cool. i have a full end to end glue now, complete with locations on a static map img tag.

#### Next ...
* I want to just add the 'start' location too. Probably different color label too
* Then place the thing into a lambda
* And then the html side needs to TLC .


### 2020-08-30

#### quick lambda test
* can i even access file system on lambda?

```python
import os
def sage_entry(event, context):
    print(os.getcwd())
    print(os.listdir('.'))

```
* heres what i get

```
/var/task
['lambda_function.py']
```

* ok but when i tried to write ... Damn does not allow.
```python
with open('/var/task/temp.blah', 'w') as fd:
    fd.write('cool beans')
```

```
Response:
{
  "errorMessage": "[Errno 30] Read-only file system: '/var/task/temp.blah'",
  "errorType": "OSError",
  "stackTrace": [
    "  File \"/var/task/lambda_function.py\", line 14, in sage_entry\n    with open('/var/task/temp.blah', 'w') as fd:\n"
  ]
}
```
* So going to have to just embed the information I need in the code itself. Not s3. thats fine.

#### the html side...
* My original demo is [here](https://bike-hop-predict.s3.amazonaws.com/index.html)


### 2020-08-31

#### note
*  ok so since cannot write to file system, must change the entry function since cannot use joblib because it requires disk.
* I can still keep the extra info on s3, just use json or pickle instead since those dont need disk.


```python
In [1]: import joblib                                                           

In [2]: import fresh.lambda_entry as fle                                        

In [3]: bundle = fle.fetch_bundle()

In [6]: import pickle                                                           

In [7]: pkl = pickle.dumps(bundle)                                              

In [8]: import fresh.s3utils as fs3                                             


In [12]: loc = 'bikelearn/artifacts/2020-08-19T144654Z/all_bundle_with_stationsdf_except_xgb.pkl'                                                      

In [13]: fs3.write_s3_file(bucket_name, loc, pkl)                               

```

### 2020-09-02

#### update w that pkl..
* ok cool updated code w/ pkl instead of joblib/disk dependence and all good.

### 2020-09-03

#### Next
* test this code on lambda, along w/ docker update on sagemaker
* the lambda entry must also return the img html to the browser ajax call
* fast follow: the "Source station" should also be a special label in the static map diagram too!
* the API Gateway authentication : how to authenticate now?

#### api gateway authentication
* previously I was using the access keys/secrets as inputs to the actual html form. I guess I can still see if that works?
* that's a super bare bones mvp haha. But might as well see if it works.


#### zip
* uploaded the `foo.zip` created like this to lambda..
```
zip   -r foo fresh -i \*.py
```
* but ran into this on lambda darn..

```
Response:
{
  "errorMessage": "Unable to import module 'fresh.lambda_entry': No module named 'pandas'",
  "errorType": "Runtime.ImportModuleError"
}
```

#### tried another sagemaker model endpoint
* hmm but failed with this ..

```
Traceback (most recent call last):
  File "/opt/conda/lib/python3.7/site-packages/flask/app.py", line 2447, in wsgi_app
    response = self.full_dispatch_request()
  File "/opt/conda/lib/python3.7/site-packages/flask/app.py", line 1952, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "/opt/conda/lib/python3.7/site-packages/flask/app.py", line 1821, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File "/opt/conda/lib/python3.7/site-packages/flask/_compat.py", line 39, in reraise
    raise value
  File "/opt/conda/lib/python3.7/site-packages/flask/app.py", line 1950, in full_dispatch_request
    rv = self.dispatch_request()
  File "/opt/conda/lib/python3.7/site-packages/flask/app.py", line 1936, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File "/opt/server/predictor.py", line 82, in ping
    record = make_canned_record()

NameError: name 'make_canned_record' is not defined
```

#### Summary
* updated lambda entry code to return the map html
* tried another sagemaker docker go.
* zip + a lambda build go.

#### Next
* got to fix that sagemaker `make_canned_record` missing dependency
* pandas into lambda layer + retry
* try pipeline again.


### 2020-09-04

#### pandas layer
* Just out of convenience, I ran this in my running docker. ( Thanks to convenient refresher notes [here](https://medium.com/swlh/how-to-add-python-pandas-layer-to-aws-lambda-bab5ea7ced4f) )
```
mkdir python
pip install -t python pandas pytz
rm -r python/numpy*
```
* Not having `zip` in my docker, i ran the zip part on the mac host
```
zip -r python.zip python

# $ ls -lh python.zip
# 16M
```
* And I uploaded this to s3, and built a lambdas layer
* And the dependency was now good. but failed for joblib!.
* I commented out the joblib but then sklearn. Right also forgot about that.


#### summary
* Ok built pandas layer
* uncommented joblib dependency, but found sklearn dependency also needs to be met


#### NExt
* sklearn dependency needs to be layered up too!.
* And as from earlier, got to re-build the docker image w/ the `make_canned_record` fix.

### 2020-09-05

#### add other dependencies to layers...

```
mkdir python
pip install -t python pandas pytz
rm -r python/numpy*

# adding some more...
pip install -t python scikit-learn==0.22.1

```
*  ok ... made another layer for sklearn

```
zip -r python.zip python

# $ ls -lh python.zip
# 70M

rm -r python/scipy* python/numpy* python/pandas* python/pytz* python/dateutil*
rm -r python/six* python/python_dateutil*

# $ ls -lh python.zip
# 9.8M
```


#### zip lambda code again ...
* (because try except around a tqdm import)
* uploaded the `foo.zip` created like this to lambda..
```
zip   -r foo fresh -i \*.py
```

##### Dang also requests...
* separate layer for that ...

```
mkdir python
pip install -t python requests
```
*
```
zip -r python.zip python
# 904K
```

##### Access denied
* hmm need fix permission for s3...
```
"errorMessage": "An error occurred (AccessDenied) when calling the GetObject operation: Access Denied",
```

* Ah ok ... the reason was that (1) I was missing the GetObject IAM policy from my Lambda Role,
* (2) But then also I had an environmental variable ACCESS KEY I was defining in my `fresh/s3utils.py` code , which also did not have the permission
* So Removing the ACCESS KEY from my Lambda environmental variables and adding the permission to the Lambda Role freed up the lambda to use the permission through the IAM Role itself!

##### ok and rebuild the sagemaker docker ...
* ...  and got to repackage the model again think got to do that differently ..

```
cd artifacts/2020-08-19T144654Z

```

* Ok had to repackage the `model.tar.gz` without the `model` dir.
* and now `purple-bottleneck-epsilon` is In Service

#### Next
* Ok so try to hit sagemaker endpoint from the lambda then.


### 2020-09-07

#### Summary
* ok was able to hit sagemaker endpoint from the lambda after some tweaks.
* Also tested the `index.html` form i have on my s3 bucket, with some random data

#### next
* update the client javascript to embed the image from the response .

### 2020-09-08

#### to be easier, just perhaps a script that pushes my client code to s3
* hmm ok i have a deploys script thats deploying,
* but now the static website no longer serves instead now it is just making me download the index.html for some reason .
* weird.

#### Summary
* got a deploy script to s3 static (but needs tweaking)

#### Next
* Got to make the s3 deploy script not cause the s3 static hosting to break .


### 2020-09-09

#### two domain names..?
* This is the one that worked before I uploaded again  https://bike-hop-predict.s3.amazonaws.com/index.html
* And when I went into "Static website hosting" properties of my S3 bucket, I saw this new url I dont recall http://bike-hop-predict.s3-website-us-east-1.amazonaws.com
* But both prompt to just download the `index.html` file now
* and wow [this doc](https://docs.aws.amazon.com/AmazonS3/latest/dev/IndexDocumentSupport.html) has one more..
http://bike-hop-predict.s3-website.us-east-1.amazonaws.com/
* Hmm I also tried again manually uploading through the console, still not working.
* Per [here](https://stackoverflow.com/questions/25734480/website-hosted-on-s3-just-downloads-a-blank-file#25739950) I did check the `Content-type` and it was already `text/html` but I did just edit and save again. Still nothing.

##### ah uploading again
*  scrolling down, content-type must be selected in the beginning and cannot be changed after uploading
* so this time worked!

#### ok now trying to properly edit the html to insert the img
* so far just displaying the raw <img> html as a string literal
* tried `$('#' + output_id).text(JSON.stringify(response));`  that initially was bad because the `JSON.stringify` was escaping the quotation marks weird
* Then I tried without the `JSON.stringify` but still just raw string. except not escaped
* Then tried `document.getElementById(output_id_2).innerHTML=response['map_html'];`  . that worked except for the first try when I left the `"#"` prepended in the `getElementById`

```
Uncaught TypeError: Cannot set property 'innerHTML' of null
    at Object.success (fetch_data.js:408)
    at i (jquery-3.2.0.min.js:2)
    at Object.fireWith [as resolveWith] (jquery-3.2.0.min.js:2)
    at A (jquery-3.2.0.min.js:4)
    at XMLHttpRequest.<anonymous> (jquery-3.2.0.min.js:4)

```
* So yea now works!


#### Summary
* Yay figured out the weirdness around the content type .
* and updated the javascript to properly edit the inner html to insert the meticulously produced `<img>` tag!.


#### Next
* Should update that s3 deploy to actually use the `content-type` as `text/html` if I want to use that again.
* easier authentication for a true easy to use demo.
* and eventually just drop downs much easier to use


### 2020-09-10

#### hmm cognito?
* Ok cool per [docs](https://docs.aws.amazon.com/cognito/latest/developerguide/identity-pools.html#authenticated-and-unauthenticated-identities) I was able to create an "Unautenticated Identity Pool" for "Guests" who do not have to autenticate by definition.
* Wow that's exactly what I need. And this connects to an IAM role too. Quite nifty.
* Also this [starter javascript guide](https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/getting-started-browser.html) first helps with talking to cognito and then connects to Amazon Polly which converts text to speech . Haha.
* So per the steps, I attached `AmazonPollyFullAccess` to my new Unauthenticated Role.
* Ok wow the demo html worked right out of the box.

#### Summary
* Got an unauthenticated cognito identity pool created
* And tried out the identity pool with the Amazon Polly demo. Worked out of the box.

#### Next
* Use this unauthenticated identity pool with my API gateway.

### 2020-09-11

#### javascript plus cognito
* trying to decipher some of the docs like [this one](https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-generate-sdk-javascript.html)  .. There is something like `"lib/apiGatewayCore/apiGatewayClient.js"`
* The [sdk doc here](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/ApiGatewayV2.html) seems to describe managing the APIGateway not actually executing API . Umm ok.
* But reading [here](https://stackoverflow.com/questions/57680057/how-to-use-aws-cognito-to-authenticate-api-gateway) and [here](https://www.codeproject.com/Articles/5255224/Calling-API-Gateway-Cognito-from-JavaScript)  , I think the client makes a call first to get back a "Cognito-signed JWT (JSON Web Token)" and that can be used perhaps in the typical aws signing process, like what I currently use with `aws-sign-web.js`  
* Oh actually [this guide](https://github.com/mcasperson/AWSCognitoJavaScript) looks pretty detailed.
* But according to [here](https://aws-amplify.github.io/docs/) Amplify requires `$ npm install -g @aws-amplify/cli` which is a next level of intensity for sure.

#### Summary
* Created an Authorizer using Cognito.
* Researched how to actually use cognito on javascript. Found some bits and pieces of examples.

#### next
* maybe as a proof of concept, I should figure out how to make the Polly example I have spit out an Authorization token, and try using that  in a vanilla request to the API. Maybe that actually works? Maybe Cognito lets you avoid the whole AWS Signature v4 thing?
* Also interestingly enough maybe since the `AWS.config.credentials` javascript thing seems to have `accessKeyId` and `secretAccessKey` ... maybe that means something?

### 2020-09-12

#### I tried just defining the credentials, but still empty
* Using just this below, did not work

```
AWS.config.region = 'MY_REGION';
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: 'MY_IDENTITY_POOL'
});
```
* The credentials were blank, as if like uninitialized. Probably they get filled in during the `AWS.Polly()`  service call itself?

#### hmm maybe getGatewayResponse ?
* Perhaps this? https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/APIGateway.html#getGatewayResponse-property
* Maybe `getGatewayResponse` . will try.
* `getSdkType` , https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/APIGateway.html#getSdkType-property  , "Calls the GetSdkType API operation. "
* Also [this AWS documentation](https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-generate-sdk-javascript.html) that says to use something like `var apigClient = apigClientFactory.newClient();` feels outdated.
* There are EC2, S3, Kinesis, and other examples [here](https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/sdk-code-samples.html) but not APIGateway. I would think API Gateway should be a popular request.

#### config example
* Hmm [this doc](https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/global-config-object.html) has this example..

```
var myCredentials = new AWS.CognitoIdentityCredentials({IdentityPoolId:'IDENTITY_POOL_ID'});
var myConfig = new AWS.Config({
  credentials: myCredentials, region: 'us-east-1'
});

// maybe i can then add...
var apigateway = new AWS.APIGateway (myConfig);
var apigateway = new AWS.APIGateway({apiVersion: '2015-07-09',
                   params: {restApiId: 'xxxx',
                       stageName: 'default'}});


apigateway.getGatewayResponse({responseType: "DEFAULT_4XX",
                               restApiId: 'MY_REST_API_ID'}, function(err, data) {
  if (err) console.log(err, err.stack); // an error occurred
  else     console.log(data);           // successful response
});
```
* tried that ^^^ , and got ..

```
GET https://apigateway.us-east-1.amazonaws.com/restapis/xxxx/gatewayresponses/DEFAULT_4XX 403
AccessDeniedException: ....

AccessDeniedException: User: arn:aws:sts::xxxxx:assumed-role/Cognito_BikeLearnUnauth_Role/CognitoIdentityCredentials is not authorized to perform: apigateway:GET on resource: arn:aws:apigateway:us-east-1::/restapis/xxxx/gatewayresponses/DEFAULT_4XX
```
* Actually a pretty informative error. Wish I knew what the right method was though haha. This is definitely not the one.

```
https://{restapi_id}.execute-api.{region}.amazonaws.com/{stage_name}/
```

##### Oh wow I think I found a really good example
* First, I think the answer to the question of how do you invoke APIs is still to use vanilla HTTP GET/POST. That's why I couldnt find anything for that in the javascript sdk.
* and the javascript sdk , as per this [awesome stack overflow question](https://stackoverflow.com/questions/36929336/how-to-call-aws-api-gateway-endpoint-with-cognito-id-configuration#36941672) , is useful for actually getting the Cognito service to spit back out the tokens I need for filling the HTTP Authorization header...

```javascript
AWS.config.region = 'us-east-1'; // Region
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: 'us-east-1:XXXXXXXXXXXXXXXXXXXXXXXX' // your identity pool id here
});

AWSCognito.config.region = 'us-east-1';
AWSCognito.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: 'us-east-1:XXXXXXXXXXXXXXXXXXXXXXXX' // your identity pool id here
});

var poolData = {
  UserPoolId: 'us-east-1_XXXXXXXX',
  ClientId: 'XXXXXXXXXXXXXXXXXXXXXXXX'
};
var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);


var authenticationData = {
  Username: 'user',
  Password: '12345678',
};
var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData);
var userData = {
  Username: 'user',
  Pool: userPool
};
var cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);
cognitoUser.authenticateUser(authenticationDetails, {
  onSuccess: function (result) {
  console.log('access token + ' + result.getAccessToken().getJwtToken());

  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: 'us-east-1:XXXXXXXXXXXXXXXXXXXX',
    IdentityId: AWS.config.credentials.identityId,
    Logins: {
      'cognito-idp.us-east-1.amazonaws.com/us-east-1_XXXXXX': result.idToken.jwtToken
    }
  });

  AWS.config.credentials.get(function (err) {
    // now I'm using authenticated credentials
    if(err)
    {
      console.log('error in autheticatig AWS'+err);
    }
    else
    {
      console.log(AWS.config.credentials.identityId);

    }
  });
  },

  onFailure: function (err) {
    alert(err);
  }

});

```
* Also [this aws blog post](https://aws.amazon.com/blogs/mobile/use-amazon-cognito-in-your-website-for-simple-aws-authentication/) looks pretty good too.
* kept original above ^^^ from question.. And tweaking below for my case, which is anonymous as opposed to specific user/pass


##### the cognito post kept getting cancelled.
* I just kept seeing `XHR failed loading: POST` . but per [stackoverflow](https://stackoverflow.com/questions/38374549/xhr-failed-loading-post)  , I needed to prevent my form from reloadingthe page because it was killing the XHR !! right. right.
* So I added `action="#0"` into the `<form>` tag. That fixed that problem

* ANOTHER problem was my cognito call I think was running async, finishing after I was actually calling my API Gateway endpoint.
* So I made the function that calls my endpoint as a parameter to the cognito function ...
* That made the code messy but it started to appear to call in sequence.
```javascript
authParametersFromCognito = function(callback, callback_params) {

  AWS.config.region = 'us-east-1';
  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: 'MY_IDENTITY_POOL'
      });

  AWS.config.credentials.get(function(err) {
    if (err) {
      console.log("Error: "+err);
      return;
    }
    console.log("Cognito Identity Id: " + AWS.config.credentials.identityId);

    authparameters = {
      'accessKeyId': AWS.config.credentials.accessKeyId,
      'secretAccessKey': AWS.config.credentials.secretAccessKey,
      // save for later...?
      // 'sessionToken': AWS.config.credentials.sessionToken
    }
    //
    console.log('parameters from form: ' + JSON.stringify(callback_params));
    callback(callback_params, authparameters, 'out-div', 'out-div-2');
    });
}

```

#### but now a new problem, now my api gateway call is showing CORS weirdness
* not sure why this is happening now or why not before. I thought I already enabled CORS.
```
Access to XMLHttpRequest at 'https://xxxx.execute-api.us-east-1.amazonaws.com/default/myBikelearnSageLambda?birth_year=&rider_gender=&rider_type=&start_station=&start_time=' from origin 'https://bike-hop-predict.s3.amazonaws.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```
* Did my resource change?
* This is especially weird, because on the API Gateway, I have this in my "Enable CORS" setting:

```
Access-Control-Allow-Origin*: '*'
```
* And the `'*'` means every origin is allowed.

```
'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'
```

##### changing back to original code
* Hmm now I also dont know what happened but now the original code is getting a `401` now. (not a CORS error?)
* But i did switch over to the new authorizer however. so perhaps this is related to new authorization ..
* Ok, and when I switched back to original authorizer, code now works again .


### 2020-09-15

#### try cors  again
* also interesting [stack here](https://stackoverflow.com/questions/48140465/aws-cognito-and-cors-security-concern)
* So trying again now w/ the Cognito approach , and getting back a `401` and a console error again says

```
Access to XMLHttpRequest at https://xxxx.execute-api.us-east-1.amazonaws.com/default/myBikelearnSageLambda?birth_year=&rider_gender=&rider_type=&start_station=&start_time= from origin https://bike-hop-predict.s3.amazonaws.com has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

* and the response from the error is also kind of interesting... maybe I can look that up. Not sure where the console log 'CORS' error is coming from. guess thats the browser itself generating that error?

```
{"readyState":0,"status":0,"statusText":"error"}
```
* But the Cognito call which happens first did not fail and when I look at the credentials in `AWS.config.credentials` , they were filled in .
```
{
			'accessKeyId': AWS.config.credentials.accessKeyId,
			'secretAccessKey': AWS.config.credentials.secretAccessKey,
			// save for later...
			// 'sessionToken': AWS.config.credentials.sessionToken
		}
```

### 2020-09-16

#### That error..
* that `{"readyState":0,"status":0,"statusText":"error"}` response... looks same as [here](https://salesforce.stackexchange.com/questions/158448/response-status-is-0-in-jquery-ajax)  
* And one person notes interestingly, _"A Status Code of 0 means "the browser refused to honor the request." "_ . Good to know haha.
* So that makes me think indeed CORS related still.
* hmm... something tells me I got to use the session token `AWS.config.credentials.sessionToken` in the V4 signature as well. I had been reading about this before as an optional component...
* [v4 troubleshooting](https://docs.aws.amazon.com/general/latest/gr/signature-v4-troubleshooting.html) may be useful later.

#### Security Token Service
* Hmm according to this Note ... [here](https://docs.aws.amazon.com/general/latest/gr/sigv4-create-canonical-request.html)

> You can use temporary security credentials provided by the AWS Security Token Service (AWS STS) to sign a request. The process is the same as using long-term credentials, but when you add signing information to the query string you must add an additional query parameter for the security token. The parameter name is X-Amz-Security-Token, and the parameter's value is the URI-encoded session token (the string you received from AWS STS when you obtained temporary security credentials).
> For some services, you must include the X-Amz-Security-Token query parameter in the canonical (signed) query string. For other services, you add the X-Amz-Security-Token parameter at the end, after you calculate the signature. For details, see the API reference documentation for that service.

* It looks like the `AWS.config.credentials.sessionToken` is the STS token which per above, depends on the service as to where it should go in the request as the `X-Amz-Security-Token` header.
* I dont see the Security Token mentioned [here](https://docs.aws.amazon.com/apigateway/api-reference/signing-requests/) hmm.
* Per [this](https://docs.aws.amazon.com/general/latest/gr/sigv4-add-signature-to-request.html) ...

> You can use temporary security credentials provided by the AWS Security Token Service (AWS STS) to sign a request. The process is the same as using long-term credentials.

* Maybe using `X-Amz-Security-Token` is optional ?  
* this [blog post](https://jun711.github.io/aws/how-to-sign-api-gateway-requests-with-signature-version-4-using-aws-amplify/) although it uses Amplify , but it shows at least the use of the `X-Amz-Security-Token` header following the `x-amz-date` header in the `execute-api` HTTP request. So maybe that's a path to try next?

#### Next
* So per above perhaps I can try use of `X-Amz-Security-Token` as per this blog post.
* Actually haha I am looking at the `aws-sign-web.js` which I have been using all this time... and the `sessionToken` may be provided actually.
